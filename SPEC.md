# SPEC — 기능 요구사항

> AI 릴레이 만화 | `docs/사전 개발 기획안.md` 기반 산출
>

## 1. 인증 및 접근 제한

- **열람(갤러리, 에피소드 뷰어)**: 비로그인 포함 누구나 가능.
- **에피소드 생성, 칸 추가, 릴레이 참여**: 로그인한 사용자만 가능.
- 인증 수단: **Supabase Auth — 이메일·비밀번호** (회원가입/로그인). 이메일 확인 후 로그인 가능. (향후 소셜 로그인 확장 가능.)
- 기존 익명(비로그인) 상태로 생성된 에피소드의 `creator_id`는 당시 클라이언트 식별자로 저장. 마이그레이션 플로우는 제공하지 않음.
- 비로그인 상태에서 에피소드 생성 시도 시 **로그인 페이지로 리다이렉트** (`/login?next=/create`). 로그인 후 `next` 경로로 복귀.

## 2. 에피소드 생성

- 에피소드 생성 시 **스타일 6종 프리셋** 중 하나 선택. 선택 후 변경 불가.
- **캐릭터 설명**을 텍스트로 입력. (외형, 의상, 성격 묘사)
- (선택) 제목, 한 줄 소개 입력.
- **시작 아이디어 템플릿 제공**: 스타일 선택 후 "랜덤 시작 상황 뽑기(주사위)" 버튼으로 장르별 템플릿에서 무작위 1개 추천. 선택하면 장면 설명 입력란에 자동 입력되며 수정 가능.
  - 템플릿은 스타일별 20~30개를 DB(`episode_templates` 테이블)에 사전 등록.
  - 템플릿 구조: `style`, `scene_description`, `character_hint` (선택).
- **일일 생성 제한**: 사용자 아이디당 하루 최대 10개 에피소드 생성 가능. 초과 시 "오늘 생성 가능한 만화를 모두 사용했어요" 안내.

## 3. 만화 칸 이미지 생성

- 한 칸당 **장면 설명**, **대사**, **표음**, **말풍선 위치**를 입력받아 Gemini 2.5 Flash Image로 1장 생성.
- 프롬프트 구성: 스타일 prefix + 캐릭터 고정값 + (2칸부터) 이전 칸 이미지 레퍼런스 + 현재 칸 내용.
- 생성 이미지는 세로 비율(예: 3:4 또는 9:16). Storage 저장 후 해당 칸에 URL 연결.
- 타임아웃 60초. **실패 시 칸은 DB에 저장하되 `image_url = null` 로 처리. 이미지 영역에 "이미지 준비 중" placeholder 표시. "다시 생성" 버튼 제공, 기존 입력값 유지.**
- 유해 콘텐츠 필터 시 "내용을 조금 수정해 주세요" 안내. 칸은 저장하지 않음.
- **에피소드당 최대 20칸** 제한. 20칸 도달 시 칸 추가 버튼 비활성화 및 "최대 칸 수에 도달했어요" 안내.

## 4. 멀티유저 콜라보 (턴제 릴레이)

- **콜라보 링크** 공유 시 링크로 진입한 로그인 사용자는 닉네임 입력 후 즉시 참여.
- **턴제**: 현재 차례인 참여자만 입력창 활성화. 해당 참여자가 칸 생성 완료 시 다음 차례로 자동 이전.
- **연속 등록 제한**: 한 참여자가 **연속 최대 3칸**을 등록할 수 있음. 이후에는 다른 참여자가 1칸 이상 등록해야 다시 등록 가능. (참여자가 혼자인 경우 제한 없음)
- **Supabase Realtime**으로 칸 추가·참여자 목록·현재 턴 반영. 새로고침 없이 실시간 업데이트.
- 대기 중인 참여자에게 "OO님이 그리는 중…" 등 현재 턴 표시.

## 5. AI 이어쓰기

- **3칸 이상**일 때만 "AI에게 맡기기" 버튼 활성화.
- 생성 칸 수: 1~6칸 범위에서 사용자 선택.
- **스토리 생성 프롬프트 개선**:
  - 이전 칸의 `scene_description` + `dialogue` + `sound_effect` 를 모두 context에 포함하여 감정 흐름과 캐릭터 상태 연속성 보장.
  - 현재 칸 번호(전체 칸 수 대비)를 전달해 도입부/절정/결말 톤을 다르게 유도.
  - 스타일별 톤 지시 포함: 소녀만화는 감성적·서정적, 액션은 짧고 강렬하게, 누아르는 건조하고 묵직하게 등.
  - 칸당 대사 최대 40자 제한을 프롬프트에 명시해 어색하게 긴 대사 방지.
- 각 칸 이미지 생성 실패 시 해당 칸 스킵 후 다음 칸 계속 진행.

## 6. 좋아요 / 리뷰

### 칸 단위 좋아요
- 칸마다 **엄지 업(👍) 아이콘** 표시.
- 로그인 유무 무관하게 좋아요 수 확인 가능.
- **좋아요 누르기는 로그인 사용자만** 가능. 비로그인 시 로그인 유도.
- 동일 사용자의 중복 좋아요 방지 (user_id 기반).

### 에피소드 단위 좋아요 (북마크)
- 에피소드 뷰어 상단에 **하트(❤️) 아이콘** 표시.
- **로그인 사용자만** 에피소드 단위 좋아요 가능.
- 좋아요한 에피소드는 마이페이지 "찜한 만화" 목록에서 확인.
- DB: `episode_likes` 테이블 (`episode_id`, `user_id`, UNIQUE 제약).

### 에피소드 리뷰
- 에피소드 뷰어 하단에 리뷰 목록 표시. **비로그인 포함 누구나 확인** 가능.
- **리뷰 작성은 로그인 사용자만** 가능.
- 리뷰 구성: 텍스트 (최대 200자).
- DB: `episode_reviews` 테이블 (`episode_id`, `user_id`, `content`, `created_at`).

## 7. 갤러리

- **필터**: 만화 스타일(전체 / 웹툰 / 4컷만화 / 소녀만화 / 액션 / 치비 / 누아르), 상태(전체 / 진행 중 / 완성).
- **검색**: 제목 키워드 검색.
- **정렬**: 최신순 (기본).
- **페이지네이션**: 페이지당 12개, 페이지 단위로 이동 가능.

## 8. SNS 공유

- 완성/미완성 무관 **언제든** "지금 공유하기" 제공.
- **세로 스트립 이미지** 다운로드 (PNG/JPEG). 파일명 예: `ai-relay-{episodeId}.png`.
- **고유 링크** 복사. 형식: `/e/{episodeId}` 또는 `https://도메인/c/{episodeId}`.
- (선택) QR 코드 표시.

## 9. 화면/상태

- 에피소드 생성 → 첫 칸 입력 → (콜라보 시) 대기실/차례 입력 → AI 이어쓰기(선택) → 공유.
- 공유 페이지에서 "나도 이어쓰기" CTA로 참여 플로우 진입 가능.

## 10. 예외·에러

- 이미지 생성 타임아웃/API 오류: 칸을 `image_url = null` 로 저장 후 "이미지 준비 중" placeholder 표시. 재시도 버튼 제공.
- 참여자 중도 이탈: 해당 턴 스킵 (MVP). 동시 수정 방지는 턴제 + Realtime 현재 턴 lock으로 보장.
- 최대 20칸 도달: 칸 추가/AI 이어쓰기 버튼 비활성화.
- 일일 생성 10개 초과: 에피소드 생성 폼 진입 시점에 서버에서 카운트 확인 후 차단.
- 연속 3칸 초과 시도: "다른 참여자가 그릴 차례예요" 안내.
